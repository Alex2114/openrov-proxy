<!doctype html>
<html>
  <head>
    <title>OpenROV Browser proxy middleware</title>
  </head>
  <body>
    <ul id="messages"></ul>
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="http://cdn.binaryjs.com/0/binary.js"></script>
    <script>
      // Socket and BinaryClient to the proxy service
      var proxy = {
        client: new BinaryClient('ws://build.openrov.com:3001')
      };

      // Socket and BinaryClient on the ROV
      var rov = {
        client: new BinaryClient('ws://' + document.location.host)
      };

      proxy.client.on('open', function() {
        $('#messages').append('<li>Connected to proxy</li>');
      });
      proxy.client.on('close', function() {
        $('#messages').append('<li>Disconnected from proxy</li>');
      });

      rov.client.on('open', function() {
        $('#messages').append('<li>Connected to ROV</li>');

        // We got a request from the ROV HTTP proxy
        rov.client.on('stream', function(rovStream, url) {
          $('#messages').append('<li>Requested ' + url + '</li>');

          // create a stream to the proxy on the server
          // this will trigger the download of the requested file
          proxyStream = proxy.client.createStream(url);
          // we pipe the incoming data to the rovStream
          proxyStream.pipe(rovStream);
          // when the server is done downloading it will end the stream
          proxyStream.on('end', function() {
            $('#messages').append('<li>End of stream ' + url + '</li>');
            // end the stream to the rov. This will cause the proxy to end the response
            rovStream.end();
          });
        });

      });
      rov.client.on('close', function() {
        $('#messages').append('<li>Disconnected from ROV</li>');
      });
</script>
  </body>
</html>
