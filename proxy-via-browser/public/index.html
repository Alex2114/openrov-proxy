<!doctype html>
<html>
  <head>
    <title>OpenROV Browser proxy middleware</title>
  </head>
  <body>
    <ul id="messages"></ul>
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="http://cdn.binaryjs.com/0/binary.js"></script>
    <script>
      // Socket and BinaryClient to the proxy service
      var proxy = {
        //socket: io('localhost:3001'),
        client: new BinaryClient('ws://localhost:3001'),
        stream: null
      };

      // Socket and BinaryClient on the ROV
      var rov = {
        //socket: io(),
        client: new BinaryClient('ws://' + document.location.host),
        stream: null
      };

      proxy.client.on('open', function() {
        $('#messages').append('<li>Connected to proxy</li>');
      });
      proxy.client.on('close', function() {
        $('#messages').append('<li>Disconnected from proxy</li>');
      });

      rov.client.on('open', function() {
        $('#messages').append('<li>Connected to ROV</li>');
        rov.client.on('stream', function(stream, meta) {
          rov.stream = stream;
          $('#messages').append('<li>Requested ' + meta + '</li>');
          proxy.stream = proxy.client.createStream(meta);
          proxy.stream.pipe(rov.stream);
          proxy.stream.on('end', function() {
            $('#messages').append('<li>End of stream</li>');
            rov.stream.end();
          });
        });

      });
      rov.client.on('close', function() {
        $('#messages').append('<li>Disconnected from ROV</li>');
      });
</script>
  </body>
</html>
